MapFilter=Backbone.View.extend({events:{click:"closeGraphPane"},initialize:function(e){window.app=this,this.collection.fetch({silent:!0,success:function(e,t,i){e.trigger("firstfetch",e,t,i)}}),this.mapPane=new MapFilter.MapPane({el:$('<div id="map"/>').appendTo(this.el),center:e.mapCenter,zoom:e.mapZoom,tileUrl:e.tileUrl,collection:this.collection}),this.filterPane=new MapFilter.FilterPane({collection:this.collection,filters:e.filters}),this.currentViewInfo=new MapFilter.CurrentViewInfo,this.infoPane=new MapFilter.InfoPane,this.listenTo(this.filterPane.graphPane,"opened",this.openGraphPane),this.listenTo(this.filterPane.graphPane,"closed",this.closeGraphPane),this.$el.append(this.filterPane.render().el),this.$el.append(this.infoPane.$el.hide()),this.mapPane.$(".leaflet-control-container").prepend(this.currentViewInfo.render().el)},openGraphPane:function(){this.$el.addClass("show-date-filter")},closeGraphPane:function(){this.$el.removeClass("show-date-filter")}}),MapFilter.Collection=Backbone.Collection.extend({initialize:function(e,t){t.url&&(this.url=t.url),this.crossfilter=crossfilter(),this.dimensions=[],this.resetFilter(),this.on("change remove reset",this.resetFilter),this.on("add firstfetch",this.addToFilter)},dimension:function(e){var t=this.crossfilter.dimension(e);return this.dimensions.push(t),t},resetFilter:function(){return this.dimensions.forEach(function(e){e.filterAll()}),this.crossfilter.remove(),this.addToFilter(this.models),this},addToFilter:function(e){return e instanceof Backbone.Collection&&(e=e.models),this.crossfilter.add(e)}}),MapFilter.MapPane=Backbone.View.extend({initialize:function(e){this.map=L.map(this.el,{center:e.center,zoom:e.zoom}),this.tiles=L.tileLayer(e.tileUrl).addTo(this.map),this.markersById={},this.dimension=this.collection.dimension(function(e){return e.cid}),this.group=this.dimension.group(),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"firstfetch reset",this.addAll),this.listenTo(this.collection,"remove",this.removeOne),this.listenTo(this.collection,"filtered",this.filter)},addOne:function(e){this.markersById[e.cid]=new MapFilter.MarkerView({model:e,map:this.map})},addAll:function(){this.removeAll(),this.collection.each(this.addOne,this)},removeOne:function(e){this.markersById[e.cid].remove(),delete this.markersById[e.cid]},removeAll:function(){_.each(this.markersById,function(e){this.removeOne(e.model)},this)},filter:function(){this.group.all().forEach(function(e){this.markersById[e.key].show(e.value)},this)}}),MapFilter.MarkerView=Backbone.View.extend({events:{mouseover:"onMouseOver",mouseout:"onMouseOut",click:"onClick"},icon:L.divIcon({html:'<svg><g transform="translate(4,4.5)"><path class="outline" d="M 17,8 C 17,13 11,21 8.5,23.5 C 6,21 0,13 0,8 C 0,4 4,-0.5 8.5,-0.5 C 13,-0.5 17,4 17,8 z"/><path class="fill" d="M 17,8 C 17,13 11,21 8.5,23.5 C 6,21 0,13 0,8 C 0,4 4,-0.5 8.5,-0.5 C 13,-0.5 17,4 17,8 z"/></g></svg><div class="marker-text"/>',iconSize:[25,34],iconAnchor:[12.5,30],className:"marker"}),initialize:function(e){var t=this.model.coordinates();t[0]&&t[1]||(t=[0,0]),this.marker=L.marker(t,{icon:this.icon}).addTo(e.map),this.setElement(this.marker._icon),this.$el.addClass(this.model.get("happening")),this._lastZIndex=this.marker.options.zIndexOffset},render:function(){$(".marker-text",this.el).html(""),this.marker.update()},remove:function(){this.marker._map.removeLayer(this.marker)},onMouseOver:function(e){e.stopPropagation(),this.$el.addClass("hover"),app.infoPane.show({model:this.model})},onMouseOut:function(){this.$el.removeClass("hover"),app.infoPane.hide()},onClick:function(e){e.stopPropagation(),this.$el.toggleClass("clicked"),app.infoPane.toggle({model:this.model,sticky:!0,iconView:this})},show:function(e){this.marker.setOpacity(e?1:.15),e?this.marker.setZIndexOffset(this._lastZIndex):(this._lastZIndex=this.marker.options.zIndexOffset,this.marker.setZIndexOffset(-99999))}}),MapFilter.CurrentViewInfo=Backbone.View.extend({id:"filter-info",render:function(){return this.$el.html("Showing <strong>all activities</strong> by <strong>all monitors</strong> on <strong>all dates</strong>"),this},constructFilterText:function(){}}),MapFilter.InfoPane=Backbone.View.extend({id:"info-pane",events:{"click .close":"close"},initialize:function(){this.template=_.template($("#template-info-pane").html())},render:function(){this.$el.html(this.template(this.model))},show:function(e){this.sticky()||(this.hide(),this.model=e.model,this.iconView=e.iconView,this.render(),this.sticky(e.sticky),this.$el.show())},toggle:function(e){this.sticky(!1),this.iconView===e.iconView?(this.hide(),this.iconView=null):(this.iconView&&this.iconView.$el.removeClass("clicked"),this.show(e))},sticky:function(e){return e===void 0?this._sticky:(e?this.$el.addClass("sticky"):this.$el.removeClass("sticky"),this._sticky=e,void 0)},close:function(){this.sticky(!1),this.iconView&&this.iconView.$el.removeClass("hover clicked"),this.hide()},hide:function(){this.sticky()||this.$el.hide()}}),MapFilter.FilterPane=Backbone.View.extend({id:"filter-pane",initialize:function(e){var t=e.filters||[];this.graphPane=new MapFilter.GraphPane({collection:this.collection}),this.$el.append(this.graphPane.render().el),this.$filters=$('<form class="form"/>').appendTo(this.el),t.forEach(function(e){this.addFilter(e)},this)},addFilter:function(e){var i;return e.field?(i="continuous"===e.type?new MapFilter.ContinuousFilterView({collection:this.collection,field:e.field,expanded:e.expanded||!1,graphPane:this.graphPane}):new MapFilter.DiscreteFilterView({collection:this.collection,field:e.field,expanded:e.expanded||!1}),this.$filters.append(i.render().el),void 0):(console.error(t("error.filter_missing")),void 0)}}),MapFilter.DiscreteFilterView=Backbone.View.extend({events:{"click .select_all":"selectAll","click .select_one":"selectOne",click:"updateFilter"},className:"filter",initialize:function(e){function t(e,t){return t.get(s).split(" ").forEach(function(t){e[t]=(e[t]||0)+1}),e}function i(e,t){return t.get(s).split(" ").forEach(function(t){e[t]-=1}),e}function n(){return{}}var s=this.field=e.field;this.$el.attr("id",s),this.template=_.template($("#template-discrete-filter").html()),this.checkboxTemplate=_.template($("#template-checkbox").html()),this.dimension=this.collection.dimension(function(e){return e.get(s)}),this.groupAll=this.dimension.groupAll().reduce(t,i,n),this.listenTo(this.collection,"firstfetch change",this.render),this.render()},render:function(){if(!this.dimension.group().size())return this;var e=[];return _.forEach(this.groupAll.value(),function(i,n){e.push(this.checkboxTemplate({key:n,text:t(this.field+"."+n),labelClass:"happening"===this.field?"label":"",className:"checkbox "+n}))},this),this.$el.html(this.template({title:t("filters."+this.field),checkboxes:e})),this},selectAll:function(){this.$("input").prop("checked",!0)},selectOne:function(e){this.$("input").prop("checked",!1),$(e.target).parents(".checkbox").find("input").prop("checked",!0)},updateFilter:function(){var e=[];this.$("input:checked").each(function(){e.push($(this).attr("value"))}),this.dimension.filter(function(t){return _.intersection(t.split(" "),e).length?!0:!1}),this.collection.trigger("filtered")}}),MapFilter.ContinuousFilterView=Backbone.View.extend({events:{"click .select_range":"showGraphPane"},className:"filter",initialize:function(e){this.field=e.field,this.graphPane=e.graphPane,this.$el.attr("id",this.field),this.format=d3.time.format("%d %b %Y"),this.template=_.template($("#template-continuous-filter").html()),this.dimension=this.collection.dimension(function(t){return new Date(t.attributes[e.field])}),this.group=this.dimension.group(d3.time.day),this.listenTo(this.collection,"filtered firstfetch",this.render)},render:function(){if(!this.dimension.top(1).length)return this;var e=this.format(this.dimension.bottom(1)[0].getDate()),t=this.format(this.dimension.top(1)[0].getDate());return this.$el.html(this.template({filterRange:e+" &mdash; "+t})),this},showGraphPane:function(e){e.stopPropagation(),this.graphPane.open()}}),MapFilter.GraphPane=Backbone.View.extend({id:"graph-pane",events:{"click .close":"close",click:"noop"},initialize:function(){var e=this;this.$el.append('<button type="button" class="close" aria-hidden="true">&times;</button>');var t=this.collection.dimension(function(e){return new Date(e.attributes.today)}),i=t.group(d3.time.day);this.barChart=MapFilter.BarChart().dimension(t).group(i).round(d3.time.day.round).x(d3.time.scale().domain([new Date(2013,9,1),new Date(2013,11,20)]).rangeRound([0,1400])).on("brush",function(){e.collection.trigger("filtered")}),this.listenTo(this.collection,"filtered",this.render)},render:function(){return this.collection.length?(d3.select(this.el).call(this.barChart),this):this},open:function(){this.trigger("opened"),this.render()},close:function(){this.trigger("closed")},noop:function(e){e.stopPropagation()}}),MapFilter.BarChart=function(){function e(e){function n(e){for(var i,n=[],s=-1,r=e.length;r>++s;)i=e[s],n.push("M",t(i.key),",",p,"V",o(i.value),"h14V",p);return n.join("")}function r(e){var t=+("e"==e),i=t?1:-1,n=p/3;return"M"+.5*i+","+n+"A6,6 0 0 "+t+" "+6.5*i+","+(n+6)+"V"+(2*n-6)+"A6,6 0 0 "+t+" "+.5*i+","+2*n+"Z"+"M"+2.5*i+","+(n+8)+"V"+(2*n-8)+"M"+4.5*i+","+(n+8)+"V"+(2*n-8)}var d=t.range()[1],p=o.range()[0];o.domain([0,s.top(1)[0].value]),e.each(function(){var e=d3.select(this),o=e.select("g");if(o.empty()){o=e.append("svg").attr("width",d+l.left+l.right).attr("height",p+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")"),o.append("clipPath").attr("id","clip-"+a).append("rect").attr("width",d).attr("height",p),o.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(e){return e+" bar"}).datum(s.all()),o.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+a+")"),o.append("g").attr("class","axis").attr("transform","translate(0,"+p+")").call(h);var u=o.append("g").attr("class","brush").call(c);u.selectAll("rect").attr("height",p),u.selectAll(".resize").append("path").attr("d",r)}if(i)if(i=!1,o.selectAll(".brush").call(c),c.empty())o.selectAll("#clip-"+a+" rect").attr("x",0).attr("width",d);else{var f=c.extent();o.selectAll("#clip-"+a+" rect").attr("x",t(f[0])).attr("width",t(f[1])-t(f[0]))}o.selectAll(".bar").attr("d",n)})}MapFilter.BarChart.id||(MapFilter.BarChart.id=0);var t,i,n,s,r,l={top:10,right:10,bottom:20,left:10},o=d3.scale.linear().range([100,0]),a=MapFilter.BarChart.id++,h=d3.svg.axis().orient("bottom"),c=d3.svg.brush();return c.on("brush.chart",function(){var e=d3.select(this.parentNode),i=c.extent();r&&e.select(".brush").call(c.extent(i=i.map(r))).selectAll(".resize").style("display",null),e.select("#clip-"+a+" rect").attr("x",t(i[0])).attr("width",t(i[1])-t(i[0])),n.filterRange(i)}),c.on("brushend.chart",function(){c.empty()&&(d3.select("#clip-"+a+" rect").attr("x",null).attr("width","100%"),n.filterAll())}),e.margin=function(t){return arguments.length?(l=t,e):l},e.x=function(i){return arguments.length?(t=i,h.scale(t),c.x(t),e):t},e.y=function(t){return arguments.length?(o=t,e):o},e.dimension=function(t){return arguments.length?(n=t,e):n},e.filter=function(t){return t?(c.extent(t),n.filterRange(t)):(c.clear(),n.filterAll()),i=!0,e},e.group=function(t){return arguments.length?(s=t,e):s},e.round=function(t){return arguments.length?(r=t,e):r},d3.rebind(e,c,"on")};